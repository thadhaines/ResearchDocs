\documentclass[12pt]{article}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}

\usepackage{geometry}
\geometry{
	letterpaper, 
	portrait, 
	top=.75in,
	left=.8in,
	right=.75in,
	bottom=.5in		} 	% Page Margins
	
%% additional packages for nice things
\usepackage{amsmath} 	% for most math
\usepackage{commath} 	% for abs
\usepackage{lastpage}	% for page count
\usepackage{amssymb} 	% for therefore
\usepackage{graphicx} 	% for image handling
\usepackage{wrapfig} 	% wrap figures
\usepackage[none]{hyphenat} % for no hyphenations
\usepackage{array} 		% for >{} column characterisctis
\usepackage{physics} 	% for easier derivative \dv....
\usepackage{tikz} 		% for graphic@!
\usepackage{circuitikz} % for circuits!
\usetikzlibrary{arrows.meta} % for loads
\usepackage[thicklines]{cancel}	% for cancels
\usepackage{xcolor}		% for color cancels
\usepackage[per-mode=fraction]{siunitx} % for si units and num
\usepackage{fancyhdr} 	% for header
\usepackage{comment}	% for ability to comment out large sections
\usepackage{multicol}	% for multiple columns using multicols
\usepackage[framed,numbered]{matlab-prettifier} % matlab sytle listing
\usepackage{marvosym} 	% for boltsymbol lightning
\usepackage{pdflscape} 	% for various landscape pages in portrait docs.
%\usepackage{float}
\usepackage{fancyvrb}	% for Verbatim (a tab respecting verbatim)
\usepackage{enumitem}	% for [resume] functionality of enumerate
\usepackage{spreadtab} 	% for using formulas in tables}
\usepackage{numprint}	% for number format in spread tab

% For table formatting
\usepackage{booktabs}
\renewcommand{\arraystretch}{1.2}
\usepackage{floatrow}
\floatsetup[table]{capposition=top} % put table captions on top of tables

% Caption formating footnotesize ~ 10 pt in a 12 pt document
\usepackage[font={small}]{caption}

%% package config 
\sisetup{output-exponent-marker=\ensuremath{\mathrm{E}}} % for engineer E
\renewcommand{\CancelColor}{\color{red}}	% for color cancels
\lstset{aboveskip=2pt,belowskip=2pt} % for more compact table
%\arraycolsep=1.4pt\def
\setlength{\parindent}{0cm} % Remove indentation from paragraphs
\setlength{\columnsep}{0.5cm}
\lstset{
	style      = Matlab-editor,
	basicstyle = \ttfamily\footnotesize, % if you want to use Courier - not really used?
}
\renewcommand*{\pd}[3][]{\ensuremath{\dfrac{\partial^{#1} #2}{\partial #3}}} % for larger pd fracs
\renewcommand{\real}[1]{\mathbb{R}\left\{ #1 \right\}}	% for REAL symbol
\newcommand{\imag}[1]{\mathbb{I}\left\{ #1 \right\}}	% for IMAG symbol
\definecolor{m}{rgb}{1,0,1}	% for MATLAB matching magenta
	
%% custom macros
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}} % for simple \numberthis command

\newcommand{\equal}{=} % so circuitikz can have an = in the labels
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

%% Header
\pagestyle{fancy} % for header stuffs
\fancyhf{}
\rhead{Thad Haines \\ Page \thepage\ of \pageref{LastPage}}
\chead{AMQP Grouping \\ MiniWecc Step Case}
\lhead{Research \\ }
% spacing
\headheight 29 pt
\headsep 6 pt

\begin{document}
\paragraph{Executive Summary:} 
\begin{enumerate}
\item Grouping messages can speed up the simulation by 1 order of magnitude compared to PSDS when using 2 second time steps ($\approx$15$\times$ real time).
\item  Grouping messages increases the average time spent sending a single message while reducing the total number of messages sent. 
\item  An optimal message size may be found to maximize these benefits.
\end{enumerate}


\paragraph{Initial Timings:} Results of a 90 second MiniWECC step test with a 0.5 second time step are shown below. Solving the power-flow, sending IPY messages, and running PY3 dynmaics are the top three time usage operations in the simulation. 
\begin{lstlisting}[caption=Initial terminal output of timings and counters.]
*** Simulation Timings
     Total Simulation Time:           28.592126
         PY3 Dynamics CPU Time:        3.267116
                 PY3 Send Time:        0.648147
              PY3 Recieve Time:       24.517481
        Uncounted PY3 Time:            0.159382
                IPY distPacc Time:     0.233406
            IPY PSLF Get/Set Time:     1.391693
             PSLF Power-Flow Time:    10.516975
                IPY Msg Make Time:     0.085266
                    IPY Send Time:    10.390213
        Uncounted IPY Time:            1.899927

*** Simulation Counters
             Power-Flow Solutions:          206
                Sent PY3 Messages:         6157
                Sent IPY Messages:        32037

*** Simulation etc
                   Simulated Time:    90.000000
             Simulation Time Step:     0.500000
                Real time Speedup:     3.147720
                     Ave P-F Time:     0.051053
           Ave. P-F per Time Step:     1.138122
                Ave. PY3 msg send:     0.000105
                Ave. IPY msg send:     0.000324
\end{lstlisting}


\paragraph{Speedup Paths:} Various ideas were generated to reduce the time spent on the top three tasks:
\begin{enumerate}
\item Group AMQP messages: The number of IPY messages could be greatly reduced by grouping agent update messages together.
\item Variable Time Step: The number of power-flows could be reduced if the time step was automatically changed based on some threshold value of a measurable quantity.
\item Grouping Dynamics: Instead of solving many small state-space systems each time step, machine governor dynamics could be combined into two larger systems that would only need to be solved once per time step. At least two systems would be required to handle non-linear characteristics. This would require each machine agent to track it's corresponding state location in the larger system(s).
\end{enumerate}
The easiest path forward to gain the most possible speed up is message grouping.


\pagebreak
\paragraph{Grouping Results:} AMQP message grouping was applied to entire types of agent message updates (i.e., all machine updates in one message, bus updates in another, and load updates in a third). Table \ref{tab:grouping speedup} shows the results of tested grouping options. Option C has the largest speed up benefit caused by reducing the number of IPY messages by 59 times while also slightly increasing PY3 Dynamic time and IPY average message time.

\begin{table}[!ht]

\renewcommand\STprintnum[1]{\numprint{#1}}
 	\nprounddigits{4}

	\npthousandsep{}
	\npdecimalsign{.}
	\footnotesize
	\begin{spreadtab}{{tabular}{rrrrrrrc}}
\toprule @	\shortstack{Message Grouping\\ \vspace{.6em}}	& @	\shortstack{Option A\\None}	& @	\shortstack{Option B\\ IPY \& PY3}	& @	\shortstack{Option C\\ IPY }	&	& @	\shortstack{Option B\\ Benefit }	& @	\shortstack{Option C\\ Benefit }	& @	Best	\\	\toprule
@	Simulation Timings	& @	[sec]	& @	[sec]	& @	[sec]	&	& @	[abs]	& @	[abs]	& @	[Option]	\\	\midrule
@	     Total Simulation Time	&	28.592126	&	20.96999	&	19.676878	&	&	1.363478285	&	1.453082445	& @	C	\\	
@	         PY3 Dynamics CPU Time	&	3.267116	&	3.368752	&	3.406628	&	&	0.969829777	&	0.959046893	& @	A	\\	
@	                 PY3 Send Time	&	0.648147	&	0.065931	&	0.642515	&	&	9.830686627	&	1.008765554	& @	B	\\	
@	                IPY distPacc Time	&	0.233406	&	0.207108	&	0.255341	&	&	1.126977229	&	0.914095269	& @	B	\\	
@	            IPY PSLF Get/Set Time	&	1.391693	&	0.964806	&	1.092232	&	&	1.442458898	&	1.274173436	& @	B	\\	
@	                IPY Msg Make Time	&	0.085266	&	0.029984	&	0.025864	&	&	2.843716649	&	3.296705846	& @	C	\\	
@	                    IPY Send Time	&	10.390213	&	1.530998	&	1.534767	&	&	6.786562099	&	6.769896017	& @	B or C	\\	
@	        Uncounted PY3 Time	&	0.159382	&	0.149224	&	0.143075	&	&	1.06807216	&	1.113975188	& @	B or C	\\	
@	        Uncounted IPY Time	&	1.899927	&	4.236898	&	1.920313	&	&	0.448424059	&	0.989384022	& @	C	\\	
@	             PSLF Power-Flow Time	&	10.516975	&	10.41629	&	10.656143	&	&	1.00966611	&	0.986940115	& @	 	\\	\midrule
@	Simulation Counters	&		&		&		&	&		&		& @		\\	\midrule
@	                Sent PY3 Messages	&	6157	&	184	&	6157	&	&	33.46195652	&	1	& @	B	\\	
@	                Sent IPY Messages	&	32037	&	543	&	543	&	&	59	&	59	& @	B or C	\\	
@	             Power-Flow Solutions	&	206	&	206	&	206	&	&	1	&	1	& @	 	\\	\midrule
@	Simulation Summary	&		&		&		&	&		&		& @		\\	\midrule
@	                Real time Speedup	&	3.14772	&	4.291848	&	4.573896	&	&	1.363478327	&	1.453082231	& @	C	\\	
@	                Average PY3 Send Time	&	0.000105	&	0.000358	&	0.000104	&	&	0.293296089	&	1.009615385	& @	A or C	\\	
@	                Average IPY Send Time	&	0.000324	&	0.00282	&	0.002826	&	&	0.114893617	&	0.114649682	& @	A	\\	
@	Average Power-Flow Time	&	0.051053	&	0.050565	&	0.051729	&	&	1.009650944	&	0.986931895	& @	 	\\	
@	Average Power-Flow / Time Step	&	1.138122	&	1.138122	&	1.138122	&	&	1	&	1	& @	 	\\	
@	                   Simulated Time	&	90	&	90	&	90	&	&	1	&	1	& @	 	\\	
@	             Simulation Time Step	&	0.5	&	0.5	&	0.5	&	&	1	&	1	& @	 	\\	\bottomrule
	\end{spreadtab}
	\caption{Timings and group message benefits of a 90 second MiniWECC load step test.}
	\label{tab:grouping speedup}
\end{table}

For this particular case, grouping messages by type can reduce the total number of messages sent by 33-59$\times$ while increasing the average message sending time by 3-10$\times$. A happy medium could be pursued to only group a certain number of messages to allow for maximum message reduction with minimal send time increase. Size of grouped messages from IPY are 23, 34, and 120 (corresponding to load, machine, and bus groupings). In the larger WECC case, a grouping method that limits size of messages will probably be required as the number of objects will be respectively $\approx$480, 124, and 182$\times$ larger. Additionally, more messages will be sent as more agents are added to the system.
\vspace{1em}

However, for the moment, a speed up of 1.45 enables the 2 second time step simulations to be 15$\times$ faster than real time ($\approx$ 1 order of magnitude faster than PSDS $\longrightarrow$ Speed Goal).

\begin{comment}

\paragraph{Grouping of IPY and PY3 messages}
\begin{verbatim}
*** psltdsim.terminal.dispSimTandC(mirror)
*** Simulation Timings
     Total Simulation Time:           20.969990
         PY3 Dynamics CPU Time:        3.368752
                 PY3 Send Time:        0.065931
              PY3 Recieve Time:       17.386083
        Uncounted PY3 Time:            0.149224
                IPY distPacc Time:     0.207108
            IPY PSLF Get/Set Time:     0.964806
             PSLF Power-Flow Time:    10.416290
                IPY Msg Make Time:     0.029984
                    IPY Send Time:     1.530998
        Uncounted IPY Time:            4.236898

*** Simulation Counters
             Power-Flow Solutions:          206
                Sent PY3 Messages:          184
                Sent IPY Messages:          543

*** Simulation etc
                   Simulated Time:    90.000000
             Simulation Time Step:     0.500000
                Real time Speedup:     4.291848
                     Ave P-F Time:     0.050565
           Ave. P-F per Time Step:     1.138122
                Ave. PY3 msg send:     0.000358
                Ave. IPY msg send:     0.002820
\end{verbatim}
\paragraph{Grouping of IPY messages}
\begin{verbatim}
*** psltdsim.terminal.dispSimTandC(mirror)
*** Simulation Timings
     Total Simulation Time:           19.676878
         PY3 Dynamics CPU Time:        3.406628
                 PY3 Send Time:        0.642515
              PY3 Recieve Time:       15.484660
        Uncounted PY3 Time:            0.143075
                IPY distPacc Time:     0.255341
            IPY PSLF Get/Set Time:     1.092232
             PSLF Power-Flow Time:    10.656143
                IPY Msg Make Time:     0.025864
                    IPY Send Time:     1.534767
        Uncounted IPY Time:            1.920313

*** Simulation Counters
             Power-Flow Solutions:          206
                Sent PY3 Messages:         6157
                Sent IPY Messages:          543

*** Simulation etc
                   Simulated Time:    90.000000
             Simulation Time Step:     0.500000
                Real time Speedup:     4.573896
                     Ave P-F Time:     0.051729
           Ave. P-F per Time Step:     1.138122
                Ave. PY3 msg send:     0.000104
                Ave. IPY msg send:     0.002826
\end{verbatim}

\end{comment}
\end{document}